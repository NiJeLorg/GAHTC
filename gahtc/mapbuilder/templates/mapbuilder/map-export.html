{% extends 'website/base.html' %} {% load staticfiles %} {% block head_js_block %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}" async defer></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin="" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
<script type="text/javascript" src="https://unpkg.com/leaflet-geosearch@2.6.0/dist/bundle.min.js"></script>
<script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script>
<link href="https://unpkg.com/leaflet-geosearch@latest/assets/css/leaflet.css" rel="stylesheet" />
<script type="text/javascript" src="http://heyman.github.io/leaflet-areaselect/src/leaflet-areaselect.js"></script>
<link rel="stylesheet" href="https://heyman.github.io/leaflet-areaselect/src/leaflet-areaselect.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@0.4.0/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet-draw@0.4.0/dist/leaflet.draw.js"></script>
<script src="https://cdn.rawgit.com/dbazile/leaflet-image/gh-pages/leaflet-image.js"></script>
{% endblock %} {% block css_block %}
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}"> {% endblock%} {% block content%}
<div class="map-header white-header">
    <div>
        <h3 class="map-header-text" id="projectname">Prehistoric Australia</h3>
        <span class="glyphicon glyphicon-pencil edit-icon" id="editIcon"></span>
        </p>
    </div>
    <div class="step-button-holder">
        <a class="button button-group">My Maps</a>
        <a class="button button-group" id="save">Save</a>
        <a class="button button-group" id="publish">Publish</a>
    </div>
</div>
<div id="map"></div>
<div id="map-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-button">&times;</span>
        <h3 class="modal-title">Lets Make Your Map!</h3>
        <label class="label-title" for="">Name Your Project</label>
        <input id="project-title" type="text" placeholder="prehistoric australia">
        <a class="button ok-button">OK</a>
    </div>

</div>

<div class="publish-modal">
    <div class="publish-modal-content">
        <span class="close-button close-icon" id="close-icon">&times;</span>
        <div class="title-holder">Publish Your Map!</h3>
        </div>
        <h3>Preview</h3>
        <div class="content-holder">
            <div class="img-holder" id="images">
            </div>
            <div class="publish-image">
                <h4 class="modal-sub">File Size</h4>
                <div class="button-switcher">
                    <button class="size-btn" id="small">Small</button>
                    <button class="size-btn size-btn-active" id="medium">Medium</button>
                    <button class="size-btn" id="large">Large</button>
                </div>
                <div class="publish-options">
                    <h4 class="modal-sub">File Format</h4>
                    <input type="radio" name="fileFormat" id="jpeg"> JPEG
                    <br>
                    <input type="radio" name="fileFormat" id="png"> PNG
                    <br>
                    <input type="radio" name="fileFormat" id="pdf"> PDF
                    <a class="button download" id="download">Download</a>
                    <input type="checkbox" name="" id="">Share your map with the GAHTC community in the Map Index?
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    var lat = localStorage.getItem('lat');
    var long = localStorage.getItem('long');
    var center = [lat, long]
    var layerId = localStorage.getItem('layerId')
    var zoom = localStorage.getItem('zoom');
    var mapBound = JSON.parse(localStorage.getItem('bounds'));
    var southWest = [mapBound._southWest.lat, mapBound._southWest.lng],
        northEast = [mapBound._northEast.lat, mapBound._northEast.lng],
        mapBounds = [southWest, northEast];

    // initialize the map
    var map = L.map('map', {
        center: center,
        minZoom: zoom,
        zoomControl: false,
        maxBounds: mapBounds,
        preferCanvas: true
    });

    map.fitBounds(mapBounds);
    var marker = L.marker(center).addTo(map);
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: layerId,
        accessToken: '{{ MAPBOX_ACCESS_TOKEN }}'
    }).addTo(map);

    L.control.zoom({
        position: 'bottomleft'
    }).addTo(map);

    // FeatureGroup is to store editable layers
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    var drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems
        }
    });
    map.addControl(drawControl);


    map.on('draw:created', function (e) {
        var type = e.layerType,
            layer = e.layer;
        drawnItems.addLayer(layer);
        map.addLayer(drawnItems);
    });

    $('#close-button').click(function (e) {
        $('.modal').css("display", "none");
    });
    $('.ok-button').click(function (e) {
        $('.modal').css("display", "none");
        var val = $("#project-title").val()
        $("#projectname").html(val);
    });

    $('#editIcon').click(function (e) {
        $('.modal').css("display", "block");
    });


    const drawImage = (err, canvas) => {
        console.log("here");
        const url = canvas.toDataURL();
        console.log(url, 'URL');
        document.getElementById('images').style['background'] = "url(" + url + ") no-repeat center";
    }

    // publish modal
    $('#publish').click(function (e) {
        $('.publish-modal').css("display", "block");
        // leaflet image       
        leafletImage(map, drawImage)
    });



    $('#close-icon').click(function (e) {
        $('.publish-modal').css("display", "none");
    });


    function downloadImage(err, canvas) {
        var link = document.createElement('a');
        if (document.getElementById('png').checked) {
            link.download = "mymap.png";
            link.href = canvas.toDataURL('image/png')
            link.click()
        } else {
            link.download = "mymap.jpg";
            link.href = canvas.toDataURL('image/jpeg')
            link.click()
        }

    }

    $('#download').click(function (e) {
        if (document.getElementById('pdf').checked) {
            console.log('pdf loading')
        } else {
            leafletImage(map, downloadImage);
        }
    })



    // Toggle Between image size
    $('.button-switcher button').click(function () {
        $(this).siblings().removeClass('size-btn-active');
        $(this).addClass('size-btn-active');
        if (this.id == 'small') {
            imageQuality = 'small'
        } else if (this.id == 'medium') {
            imageQuality = 'medium'
        } else {
            imageQuality = 'large'
        }
    })
</script>

{% endblock%}