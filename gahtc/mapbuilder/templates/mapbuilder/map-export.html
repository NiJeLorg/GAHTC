{% extends "mapbuilder/base.html" %} {% block content%}
<div class="map-header white-header">
    <div>
        <h3 class="map-header-text" id="projectname">Name Your Project</h3>
        <span class="glyphicon glyphicon-pencil edit-icon" id="editIcon"></span>
        </p>
    </div>
    <div class="step-button-holder">
        <a class="button button-group">My Maps</a>
        <a class="button button-group" id="save">Save</a>
        <a class="button button-group" id="publish">Publish</a>
    </div>
</div>
<div class="draw-toolbar" >
    <div class="toolbar-section draw-icons">
        <a href="#" id="freedraw" class="toolbar-icon" style="background: url('../../static/css/images/freedraw.svg') no-repeat "></a>
        <a href="#" id="line" class="toolbar-icon" style="background: url('../../static/css/images/line.svg') no-repeat"></a>
        <a href="#" id="star" class="toolbar-icon" style="background: url('../../static/css/images/star.svg') no-repeat"></a>
        <a href="#" id="rect" class="toolbar-icon" style="background: url('../../static/css/images/rectangle.svg ') no-repeat"></a>
        <a href="#" id="circle" class="toolbar-icon" style="background: url('../../static/css/images/circle.svg') no-repeat"></a>
        <a href="#" id="pin" class="toolbar-icon" style="background: url('../../static/css/images/pin.svg') no-repeat"></a>
        <a href="#" id="text" class="toolbar-icon" style="background: url('../../static/css/images/type.svg') no-repeat"></a>
        <a href="#" id="image" class="toolbar-icon" style="background: url('../../static/css/images/insert_img.svg') no-repeat"></a>
    </div>
    <div class="toolbar-section edit-icons">
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/select.svg') no-repeat "></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/rotate.svg') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_color_fill.svg') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/stroke_color.svg ') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/opacity.svg') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/stroke_weight.svg') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/stroke_style.svg') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/left_arrow.svg') no-repeat"></a>
            <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/right_arrow.svg') no-repeat"></a>
    </div>
    <div class="toolbar-section format-icons">
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_color_text.svg') no-repeat "></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_bold.svg') no-repeat"></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_italic.svg') no-repeat"></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_underlined.svg ') no-repeat"></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_align_left.svg') no-repeat"></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_align_right.svg') no-repeat"></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_align_justify.svg') no-repeat"></a>
        <a href="#" class="toolbar-icon" style="background: url('../../static/css/images/format_align_center.svg') no-repeat"></a>
    </div>
    <div class="toolbar-btn-holder">
        <a href="" class="toolbar-btn">Legend</a>
        <a href="" class="toolbar-btn">Layers</a>
    </div>
</div>
<div id="map-canvas">
    <div id="lmap"></div>
    <canvas id="c"></canvas>
</div>

<div id="map-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-button">&times;</span>
        <h3 class="modal-title">Lets Make A Map!</h3>
        <label class="label-title" for="">Name Your Project</label>
        <input id="project-title" type="text" >
        <a class="button ok-button">OK</a>
    </div>

</div>

<div class="publish-modal">
    <div class="publish-modal-content">
        <span class="close-button close-icon" id="close-icon">&times;</span>
        <div class="title-holder">Publish Your Map!</h3>
        </div>
        <h3 id="preview">Preview</h3>
        <div class="content-holder">
            <div class="img-holder" id="images">
                <i class="fa fa-spinner fa-pulse" id="loader"></i>
            </div>
            <div class="publish-image">
                <h4 class="modal-sub">File Size</h4>
                <div class="button-switcher">
                    <button class="size-btn" id="small">Small</button>
                    <button class="size-btn size-btn-active" id="medium">Medium</button>
                    <button class="size-btn" id="large">Large</button>
                </div>
                <div class="publish-options">
                    <h4 class="modal-sub">File Format</h4>
                    <input type="radio" name="fileFormat" id="jpeg"> JPEG
                    <br>
                    <input type="radio" name="fileFormat" id="png"> PNG
                    <br>
                    <input type="radio" name="fileFormat" id="pdf"> PDF
                    <a class="button download" id="download">Download</a>
                    <input type="checkbox" checked>Share your map with the GAHTC community in the Map Index?
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    var lat = localStorage.getItem('lat');
    var long = localStorage.getItem('long');
    var center = [lat, long]
    var layerId = localStorage.getItem('layerId');
    var zoom = localStorage.getItem('zoom');
    var mapBound = JSON.parse(localStorage.getItem('bounds'));
    var southWest = [mapBound._southWest.lat, mapBound._southWest.lng],
        northEast = [mapBound._northEast.lat, mapBound._northEast.lng],
        mapBounds = [southWest, northEast];

    // initialize the map
    var map = L.map('lmap', {
        center: center,
        minZoom: zoom,
        maxZoom: zoom,
        zoomControl: false,
        maxBounds: mapBounds,
        preferCanvas: true
    });

    map.fitBounds(mapBounds);
   
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: layerId,
        accessToken: '{{ MAPBOX_ACCESS_TOKEN }}'
    }).addTo(map);

    var canvasF = new fabric.Canvas('c');
    const mapCanvas = $('#map-canvas');
    canvasF.setHeight(mapCanvas.height());
    canvasF.setWidth(mapCanvas.width());
    
    $('#rect').click(function(){
        var rect = new fabric.Rect({
        left: 100,
        top: 100,
        fill: 'blue',
        width: 100,
        height: 100,
        opacity: 0.5
        });
    canvasF.add(rect).setActiveObject()
    })
    $('#freedraw').click(function(){
        canvasF.isDrawingMode = true;
        canvasF.freeDrawingBrush.width = 10;
    })
    $('#line').click(function(){
        var line = new fabric.Line([50, 100, 200, 200], {
        left: 170,
        top: 150,
        stroke: 'red'
        });
        canvasF.add(line).setActiveObject()
    })

    $('#star').click(function(){
        poly = new fabric.Polygon([{ x: thisPathRect[0][0]+translate[0], y: thisPathRect[0][1]+translate[1] },
                                     { x: thisPathRect[1][0]+translate[0], y: thisPathRect[1][1]+translate[1] }, 
                                     { x: thisPathRect[2][0]+translate[0], y: thisPathRect[2][1]+translate[1] }, 
                                     { x: thisPathRect[3][0]+translate[0], y: thisPathRect[3][1]+translate[1] }], { 
        stroke: "#000000", 
        strokeWidth: 5,
        fill: tolColors[0], 
        opacity: 1.0
    });
    canvasF.add(poly);
    })

    $('#circle').click(function(){
        var circle = new fabric.Circle({ 
            radius: 50, 
            fill: 'blue',
            top: 100, 
            left: 100,
            opacity:0.5
        });
        canvasF.add(circle).setActiveObject();
    })

    $('#pin').click(function(){
        // var path="M442.403,299.827c3.029,3.586,2.863,9.155-1.075,12.467v0.039l-18.944,12.31				c-12.193,8.344-64.043,17.44-134.105-68.274c-67.512-82.587-47.776-128.087-38.612-138.521l15.769-16.238c3.683-3.097,9.272-2.697,12.418,1.124l40.986,49.007c3.019,3.625,2.872,9.164-1.065,12.516v0.039l-18.387,13.092c-7.289,7.142-1.045,18.456,6.341,29.389l34.948,41.719c16.248,15.896,25.207,23.224,33.052,18.055l15.261-16.893c3.742-3.097,9.291-2.716,12.418,1.124l40.996,48.988V299.827L442.403,299.827z M557.671,215.549c0,119.02-215.559,468.685-215.559,468.685S126.563,334.569,126.563,215.549C126.563,96.48,223.102,0,342.112,0C461.171,0,557.671,96.48,557.671,215.549zM508.889,215.549c0-91.957-74.81-166.816-166.777-166.816s-166.777,74.859-166.777,166.816s74.81,166.757,166.777,166.757S508.889,307.506,508.889,215.549z";

        // var p = new fabric.Path(path, {originX:'center', originY:'bottom', top: 200, left: 80});
        // p.scale(0.2);
        // canvas.add(p);
    })
    $('#text').click(function(){
        var text = new fabric.IText('Insert Text', {
            left: 150,
            top: 50,
            fontFamily: 'Arial'
        });
        canvasF.add(text).setActiveObject()
    })

    $('#image').click(function(){
        var rect = new fabric.Rect({
        left: 100,
        top: 100,
        fill: 'red',
        width: 20,
        height: 20,
        opacity: 0.5
        });
    canvasF.add(rect).setActiveObject()
    })


    $( document ).ready(function() {
        leafletImage(map, function(err, canvas) {
        var url = canvas.toDataURL('image/png');
        const img  = new Image;
        var dimensions = map.getSize();
        img.width = dimensions.x;
        img.height = dimensions.y;
        img.src = url;
        img.onload = function () {
            $('#lmap').remove();
            const imageBackgroundUrl = "" + url + "";
            canvasF.setBackgroundImage(imageBackgroundUrl, canvasF.renderAll.bind(canvasF));
            }
        })
    });
    
    $('#close-button').click(function (e) {
        $('.modal').css("display", "none");
    });
    $('.ok-button').click(function (e) {
        $('.modal').css("display", "none");
        var val = $("#project-title").val()
        $("#projectname").html(val);
    });

    $('#editIcon').click(function (e) {
        $('.modal').css("display", "block");
    });


    const drawImage = (err, canvas) => {
        const url = canvas.toDataURL('image/png');
        const imageBackgroundUrl = "url(" + url + ")";
        const img  = new Image;
        $('#images').css({
            'background': imageBackgroundUrl,
            'background-repeat': 'no-repeat',
            'background-size': 'cover'
        })
        img.src = url;
        img.onload = function () {
            $('#loader').hide();
        }
    }


    // publish modal
    $('#publish').click(function (e) {
        $('.publish-modal').css("display", "flex");
        // leaflet image       
        leafletImage(map, drawImage)
    });



    $('#close-icon').click(function (e) {
        $('.publish-modal').css("display", "none");
    });


    function downloadImage(err, canvas) {
        var link = document.createElement('a');
        if (document.getElementById('png').checked) {
            link.download = "mymap.png";
            link.href = canvas.toDataURL('image/png');
            link.click()
        } else {
            link.download = "mymap.jpg";
            link.href = canvas.toDataURL('image/jpeg');
            link.click()
        }

    }

    const downloadPdf = (err, canvas) => {
        const url = canvas.toDataURL("image/svg+xml", 1.0);
        var dimensions = map.getSize();
        var pdf = new jsPDF('l', 'pt', 'letter');
        pdf.addImage(url, 'PNG', 10, 10, dimensions.x * 0.5, dimensions.y * 0.5);
        pdf.save("mymap.pdf");

    }

    $('#download').click(function (e) {
        if (document.getElementById('pdf').checked) {
            leafletImage(map, downloadPdf);
        } else {
            leafletImage(map, downloadImage);
        }
    })


    // Toggle Between image size
    $('.button-switcher button').click(function () {
        $(this).siblings().removeClass('size-btn-active');
        $(this).addClass('size-btn-active');
        if (this.id == 'small') {
            imageQuality = 'small'
        } else if (this.id == 'medium') {
            imageQuality = 'medium'
        } else {
            imageQuality = 'large'
        }
    })
</script>

{% endblock%}